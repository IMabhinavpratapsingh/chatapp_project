<!DOCTYPE html>
<html>
<head>
    <title>Chat with {{ other_user.username }}</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        /* Full-screen Your Name background */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: url("https://sbpress.com/wp-content/uploads/2017/04/YourName-heading.jpg")
                       no-repeat center center fixed;
            background-size: cover;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Glass chat box */
        .chat-wrapper {
            width: 900px;
            height: 600px;
            background: rgba(2, 6, 23, 0.65);   /* transparent dark */
            border-radius: 16px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
                   /* glass effect */
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            background: rgba(2, 6, 23, 0.85);
            border-bottom: 1px solid #1f2937;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            overflow: hidden;
            margin-right: 12px;
            background: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }
        .header-text .name {
            font-weight: 600;
        }
        .header-text .status {
            font-size: 12px;
            color: #9ca3af;
        }

        .chat-body {
            flex: 1;
            padding: 16px 20px;
            background: linear-gradient(
                180deg,
                rgba(15,23,42,0.6),
                rgba(15,23,42,0.3)
            );
            overflow-y: auto;
        }

        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .message.me {
            margin-left: auto;
            background: #2563eb;
        }
        .message.them {
            margin-right: auto;
            background: #111827;
        }

        .chat-input {
            display: flex;
            padding: 12px 16px;
            border-top: 1px solid #1f2937;
            background: rgba(2, 6, 23, 0.85);
        }
        .chat-input input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            outline: none;
        }
        .chat-input button {
            margin-left: 10px;
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            background: #3b82f6;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }
        .chat-input button:hover {
            background: #2563eb;
        }

        ::-webkit-scrollbar{width:6px}
        ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
    </style>
</head>
<body>
<div class="chat-wrapper">
    <!-- Top: user photo + name -->
    <div class="chat-header">
        <div class="avatar">
            {# future: <img src="{{ other_user.profile.image.url }}" alt="{{ other_user.username }}"> #}
            {{ other_user.username|first }}
        </div>
        <div class="header-text">
            <span class="name">{{ other_user.username }}</span>
            <span class="status">Private chat • end‑to‑end vibes</span>
        </div>
    </div>

    <!-- Messages -->
    <div class="chat-body" id="chat-log">
        <div class="message them">
            Hey {{ user.username }}, this is the start of your private chat.
        </div>
        <div class="message me">
            Type below to send your first message.
        </div>
    </div>

    <!-- Input -->
    <div class="chat-input">
        <input id="chat-message-input" type="text"
               placeholder="Message {{ other_user.username }}..." autocomplete="off">
        <button id="chat-message-submit">Send</button>
    </div>
</div>

<script>
    const username = "{{ user.username|default:'guest' }}";
    const roomName = "{{ room_name }}";

    console.log('ROOM NAME =', roomName);

    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.host
        + '/ws/chat/private/' + roomName + '/'
    );

    chatSocket.onopen = function(e){
        console.log('PRIVATE WS OPEN', e);
    };

    chatSocket.onmessage = function(e){
        console.log('PRIVATE WS MESSAGE RAW =', e.data);
        const data = JSON.parse(e.data);

        const chatLog = document.getElementById('chat-log');

        const msgDiv = document.createElement('div');
        msgDiv.className = (data.username === username) ? 'message me' : 'message them';
        msgDiv.textContent = `${data.username}: ${data.message}`;
        chatLog.appendChild(msgDiv);

        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onerror = function(e){
        console.error('PRIVATE WS ERROR', e);
    };

    chatSocket.onclose = function(e){
        console.error('PRIVATE WS CLOSED', e);
    };

    function sendMessage(){
        const input = document.getElementById('chat-message-input');
        const text = input.value.trim();
        if(!text) return;

        console.log('PRIVATE WS SEND =', text);

        chatSocket.send(JSON.stringify({
            message: text,
            username: username,
        }));

        input.value = '';
    }

    document.getElementById('chat-message-submit').addEventListener('click', sendMessage);

    document.getElementById('chat-message-input').addEventListener('keyup', function(e){
        if(e.key === 'Enter') sendMessage();
    });
</script>
